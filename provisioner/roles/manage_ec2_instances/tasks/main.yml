---
- include_tasks: teardown.yml
  when: teardown|bool

- name: provision workshop in AWS public cloud
  block:
    - name: provision aws resources and instances
      include_tasks: provision.yml
      tags: provisioned

    - name: create instructor_inventory, and student files
      include_tasks: create_inventory.yml

    - name: check connectivity to nodes
      wait_for_connection:
        delay: 0
        timeout: 400
      loop: "{{ groups.check_connection }}"
      delegate_to: "{{ item }}"
      when: groups.check_connection is defined

    - name: check connectivity for port 22
      wait_for:
        host: "{{ ansible_host }}"
        timeout: 400
        port: 22
      vars:
        ansible_connection: local
      loop: "{{ groups.check_port_22 }}"
      when: groups.check_port_22 is defined

  when: not teardown|bool
